<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <meta http-equiv="cache-control" content="no-cache">
    <meta http-equiv="pragma" content="no-cache">
    <meta http-equiv="expires" content="0">
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <link rel="shortcut icon" href="img/kurento.png" type="image/png"/>

    <link rel="stylesheet" href="bower_components/bootstrap/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="bower_components/demo-console/index.css">
    <link rel="stylesheet" href="bower_components/ekko-lightbox/dist/ekko-lightbox.min.css">
    <link rel="stylesheet" href="css/kurento.css">

    <script src="https://cdn.firebase.com/libs/firebaseui/2.5.1/firebaseui.js"></script>
    <link type="text/css" rel="stylesheet" href="https://cdn.firebase.com/libs/firebaseui/2.5.1/firebaseui.css" />

    <script src="https://apis.google.com/js/client:plusone.js" type="text/javascript"></script>

    <script src="https://www.gstatic.com/firebasejs/4.12.0/firebase.js"></script>
    <script>
      // Initialize Firebase
      var config = {
        apiKey: "AIzaSyD1tI_vzuRnpKXMj630Pnc0yS504qDRVA8",
        authDomain: "eyecontact-in.firebaseapp.com",
        databaseURL: "https://eyecontact-in.firebaseio.com",
        projectId: "eyecontact-in",
        storageBucket: "",
        messagingSenderId: "989889011102",

        clientId: "989889011102-p3ou9clh9o5k79ob3s97su8qpibes41l.apps.googleusercontent.com",

        scopes: [
                  "https://www.googleapis.com/auth/contacts.readonly"
        ],
        discoveryDocs: [
          "https://www.googleapis.com/discovery/v1/apis/people/v1/rest"
        ]
      };
      firebase.initializeApp(config);

      var ui = new firebaseui.auth.AuthUI(firebase.auth());

      // firebase.auth().onAuthStateChanged(function(user) {
      //   // Make sure there is a valid user object
      //   if(user){
      //     var script = document.createElement('script');
      //     script.type = 'text/javascript';
      //     script.src = 'https://apis.google.com/js/api.js';
      //     // Once the Google API Client is loaded, you can run your code
      //     script.onload = function(e){
      //      // Initialize the Google API Client with the config object
      //      gapi.client
      //        .init({
      //          apiKey: config.apiKey,
      //          clientId: config.clientID,
      //          discoveryDocs: config.discoveryDocs,
      //          scope: config.scopes.join(' '),
      //        })
      //        // Loading is finished, so start the app
      //        .then(function() {
      //         // Make sure the Google API Client is properly signed in
      //         if (gapi.auth2.getAuthInstance().isSignedIn.get()) {
      //           console.log(user);
      //           manageUser(user);
      //         } else {
      //           firebase.auth().signOut(); // Something went wrong, sign out
      //         }
      //       });
      //     }
      //     // Add to the document
      //     document.getElementsByTagName('head')[0].appendChild(script);
      //   }
      // });

      var uiConfig = {
        callbacks: {
          signInSuccess: function(currentUser, credential) {
            // User successfully signed in.

            var synth = window.speechSynthesis;
            var utterThis = new SpeechSynthesisUtterance(currentUser.providerData[0].email + "authenticated using " + currentUser.providerData[0].providerId);

            // synth.speak(utterThis);

            var script = document.createElement('script');
            script.type = 'text/javascript';
            script.src = 'https://apis.google.com/js/api.js';
            // Once the Google API Client is loaded, you can run your code
            script.onload = function(e) {

              gapi.client.setApiKey("");

              gapi.client.setToken(credential.accessToken);

              // Initialize the Google API Client with the config object
              gapi.client.init(
              {
                apiKey: "AIzaSyBmFEUbUi4GudkxuWpLbKLilEQIRY92GeU",
                clientId: config.clientId,
                discoveryDocs: config.discoveryDocs,
                scope: config.scopes.join(' ')
              })
              // Loading is finished, so start the app
              .then(function() {

                // console.log("dssaddssadsasddsasad")

                console.log(credential);

                gapi.client.setToken(credential.accessToken);
                gapi.client.people.people.connections.list({
                  'resourceName': 'people/me',
                  'pageSize': 10,
                  'personFields': 'names,emailAddresses',
                }).then(function(response) {
                  var connections = response.result.connections;
                  console.log(connections);
                }),

                manageUser(currentUser),
                activatePage()
              });
            }
            // Add to the document
            document.getElementsByTagName('head')[0].appendChild(script);

            // manageUser(currentUser);
            // activatePage();

            // Return type determines whether we continue the redirect automatically
            // or whether we leave that to developer to handle.
            return false;
          },
          uiShown: function() {
            // The widget is rendered.
            // Hide the loader.
            document.getElementById('loader').style.display = 'none';
          }
        },
        // Will use popup for IDP Providers sign-in flow instead of the default, redirect.
        signInFlow: 'popup',
        // signInSuccessUrl: '/index2.html',
        signInOptions: [
          {
            provider: firebase.auth.GoogleAuthProvider.PROVIDER_ID,
            scopes: config.scopes,
            customParameters: {
              // Forces account selection even when one account
              // is available.
              prompt: 'select_account'
            }
          }
        ]
        // Terms of service url.
        // tosUrl: 'index.html'
      };

      ui.start('#firebaseui-auth-container', uiConfig);

      // firebase.auth().onAuthStateChanged(function(user) {
      //
      //   // Make sure there is a valid user object
      //   if (user) {
      //     var script = document.createElement("script");
      //     script.type = "text/javascript";
      //     script.src = "https://apis.google.com/js/api.js";
      //     // Once the Google API Client is loaded, you can run your code
      //     script.onload = function(e) {
      //       // Initialize the Google API Client with the config object
      //       console.log(user),
      //       gapi.client
      //         .init({
      //           apiKey: config.apiKey,
      //           clientId: config.clientID,
      //           discoveryDocs: config.discoveryDocs,
      //           scope: config.scopes.join(" ")
      //         }).then(function() {
      //
      //           firebase.auth().currentUser.getToken().then(function() {
      //             gapi.client.people.people.connections.list({
      //               'resourceName': 'people/me',
      //               'pageSize': 10,
      //               'personFields': 'names,emailAddresses',
      //             }).then(function(response) {
      //               var connections = response.result.connections;
      //               console.log(connections);
      //             })
      //
      //           })
      //         })
      //     };
      //     // Add to the document
      //     document.getElementsByTagName("head")[0].appendChild(script);
      //   }
      // });



    </script>

    <script src="bower_components/adapter.js/adapter.js"></script>
    <script src="bower_components/jquery/dist/jquery.min.js"></script>
    <script src="bower_components/bootstrap/dist/js/bootstrap.min.js"></script>
    <script src="bower_components/demo-console/index.js"></script>
    <script src="bower_components/draggabilly/dist/draggabilly.pkgd.min.js"></script>
    <script src="bower_components/ekko-lightbox/dist/ekko-lightbox.min.js"></script>

    <script src="bower_components/kurento-utils/js/kurento-utils.js"></script>

    <script src="js/index.js"></script>
    <title>Kurento Tutorial 4: Video Call 1 to 1 with WebRTC</title>
  </head>
  <body>
    <div id="authPage">
      <h1>Welcome to My Awesome App</h1>
      <div id="firebaseui-auth-container"></div>
      <div id="loader">Loading...</div>
    </div>

    <div id="activePage" style="display:none">
      <header>
        <div class="navbar navbar-inverse navbar-fixed-top">
          <div class="container">
            <div class="navbar-header">
              <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse"></button>
              <a class="navbar-brand" href=".">Kurento Tutorial</a>
            </div>
            <div class="collapse navbar-collapse"
              id="bs-example-navbar-collapse-1">
              <ul class="nav navbar-nav navbar-right">
                <li>
                  <a href="https://github.com/Kurento/kurento-tutorial-node/tree/develop/kurento-one2one-call">
                    <span class="glyphicon glyphicon-file"></span> Source Code</a>
                </li>
              </ul>
            </div>
          </div>
        </div>
      </header>

      <div class="container">
        <div class="page-header">
          <h1>Tutorial 4: Video Call 1 to 1 with WebRTC</h1>
          <p>
            This web application consists on an one to one video call using <a
              href="http://www.webrtc.org/">WebRTC</a>. In other words, this
            application is similar to a phone but also with video. The <a
              href="img/pipeline.png" data-toggle="lightbox"
              data-title="Video Call 1 to 1 Media Pipeline"
              data-footer="Two interconnected WebRtcEnpoints Media Elements">Media
              Pipeline</a> is composed by two interconnected <i>WebRtcEndpoints</i>.
            To run this demo follow these steps:
          </p>
          <ol>
            <li>Open this page with a browser compliant with WebRTC (Chrome, Firefox).</li>
            <li>Type a nick in the field <i>Name</i> and click on <i>Register</i>.</li>
            <li>In a different machine (or a different tab in the same browser) follow the same procedure to register another user.</li>
            <li>Type the name of the user to be called in the field <i>Peer</i> and click <i>Call</i>.</li>
            <li>Grant the access to the camera and microphone for both users. After the SDP negotiation the communication should start.</li>
            <li>The called user should accept the incoming call (by a confirmation dialog).</li>
            <li>Click on <i>Stop</i> to finish the communication.</li>
          </ol>
        </div>
        <div class="row">
          <div class="col-md-5">
            <label class="control-label" for="name">Name</label>
            <div class="row">
              <div class="col-md-6">
                <input id="name" name="name" class="form-control" type="text"/>
              </div>
              <div class="col-md-6 text-right">
                <a id="register" href="#" class="btn btn-primary">
                  <span class="glyphicon glyphicon-plus"></span> Register</a>
              </div>
            </div>
            <br/>
            <br/>
            <label class="control-label" for="peer">Peer</label>
            <div class="row">
              <div class="col-md-6">
                <input id="peer" name="peer" class="form-control" type="text">
              </div>
              <div class="col-md-6 text-right">
                <a id="call" href="#" class="btn btn-success">
                  <span class="glyphicon glyphicon-play"></span> Call</a>
                <a id="terminate" href="#" class="btn btn-danger">
                  <span class="glyphicon glyphicon-stop"></span> Stop</a>
              </div>
            </div>
            <br/>
            <label class="control-label" for="console">Console</label><br><br>
            <div id="console" class="democonsole">
              <ul></ul>
            </div>
          </div>
          <div class="col-md-7">
            <div id="output">
            </div>
          </div>
          <div class="col-md-7">
            <div id="videoBig">
              <video id="videoOutput" autoplay width="640px" height="480px" poster="img/kurento.png"></video>
            </div>
            <div id="videoSmall">
              <video id="videoInput" autoplay width="240px" height="180px" poster="img/webrtc.png"></video>
            </div>
          </div>
        </div>
      </div>

      <footer>
        <div class="foot-fixed-bottom">
          <div class="container text-center">
            <hr/>
            <div class="row">&copy; 2014-2015 Kurento</div>
            <div class="row">
              <div class="col-md-4">
                <a href="http://www.urjc.es">
                  <img src="img/urjc.gif" alt="Universidad Rey Juan Carlos" height="50px"/>
                </a>
              </div>
              <div class="col-md-4">
                <a href="http://www.kurento.org">
                  <img src="img/kurento.png" alt="Kurento" height="50px"/>
                </a>
              </div>
              <div class="col-md-4">
                <a href="http://www.naevatec.com">
                  <img src="img/naevatec.png" alt="Naevatec" height="50px"/>
                </a>
              </div>
            </div>
          </div>
        </div>
      </footer>

    </div>


  </body>
